@startuml 02_Repository_Layer
!include 00_Styling.puml
!include 01_Entity_Layer.puml

package "Repository Layer" {

    ' ==================== BRANCH & USER REPO ====================
    interface BranchRepository <<Repository>> {
        + save(branch: Branch): Branch
        + findById(id: Long): Optional<Branch>
        + findByName(name: String): Optional<Branch>
        + findAll(): List<Branch>
        + existsByName(name: String): boolean
        + deleteById(id: Long): void
    }

    interface UserRepository <<Repository>> {
        + save(user: User): User
        + findById(id: Long): Optional<User>
        + findByUsername(username: String): Optional<User>
        + findByEmail(email: String): Optional<User>
        + findByBranchId(branchId: Long): List<User>
        + existsByUsername(username: String): boolean
        + existsByEmail(email: String): boolean
        + deleteById(id: Long): void
    }

    ' ==================== DEPOT, FLEET, VEHICLE REPO ====================

    interface DepotRepository <<Repository>> {
        + save(entity: Depot): Depot
        + findById(id: Long): Optional<Depot>
        + findByBranchId(branchId: Long): List<Depot>
        + findByBranchIdAndName(branchId: Long, name: String): Optional<Depot>
        + existsByBranchId(branchId: Long): boolean
        + deleteById(id: Long): void
    }

    interface FleetRepository <<Repository>> {
        + save(entity: Fleet): Fleet
        + findById(id: Long): Optional<Fleet>
        + findByBranchId(branchId: Long): Optional<Fleet>
        + existsByBranchId(branchId: Long): boolean
        + deleteById(id: Long): void
    }

    interface VehicleRepository <<Repository>> {
        + save(entity: Vehicle): Vehicle
        + findById(id: Long): Optional<Vehicle>
        + findByFleetId(fleetId: Long): List<Vehicle>
        + findByStatus(status: VehicleStatus): List<Vehicle>
        + findByVehicleLicensePlate(plate: String): Optional<Vehicle>
        + existsByVehicleLicensePlate(plate: String): boolean
        + deleteById(id: Long): void
    }

    ' ==================== ORDER REPO ====================

    interface OrderRepository <<Repository>> {
        + save(entity: Order): Order
        + findById(id: Long): Optional<Order>
        + findByBranchId(branchId: Long): List<Order>
        + findByBranchIdAndStatus(branchId: Long, status: OrderStatus): List<Order>
        + findByBranchIdAndOrderCode(branchId: Long, code: String): Optional<Order>
        + existsByBranchIdAndOrderCode(branchId: Long, code: String): boolean
        + findOrdersWithinRadius(branchId: Long, point: String, radius: double): List<Order>
        + deleteById(id: Long): void
    }

    ' ==================== NEW: OPTIMIZATION JOB REPO ====================

    interface OptimizationJobRepository <<Repository>> {
        + save(entity: OptimizationJob): OptimizationJob
        + findById(id: Long): Optional<OptimizationJob>
        + findByBranchId(branchId: Long): List<OptimizationJob>
        + findByBranchIdOrderByCreatedAtDesc(branchId: Long, pageable: Pageable): List<OptimizationJob>
        + findByUserId(userId: Long): List<OptimizationJob>
        + findByUserIdOrderByCreatedAtDesc(userId: Long): List<OptimizationJob>
        --
        + existsByBranchIdAndStatus(branchId: Long, status: JobStatus): boolean
        + countByBranchIdAndStatus(branchId: Long, status: JobStatus): int
        + findFirstByBranchIdAndStatusOrderByCreatedAtDesc(branchId: Long, status: JobStatus): Optional<OptimizationJob>
        + findByBranchIdAndStatusIn(branchId: Long, statuses: List<JobStatus>): List<OptimizationJob>
        --
        + findByStatusAndCreatedAtBefore(status: JobStatus, cutoffDate: LocalDateTime): List<OptimizationJob>
        + findByCreatedAtBeforeAndStatusIn(cutoffDate: LocalDateTime, statuses: List<JobStatus>): List<OptimizationJob>
        --
        + deleteById(id: Long): void
    }

    ' ==================== UPDATED: SOLUTION REPO ====================

    interface SolutionRepository <<Repository>> {
        + save(entity: Solution): Solution
        + findById(id: Long): Optional<Solution>
        + findByJobId(jobId: Long): Optional<Solution>
        + findByBranchId(branchId: Long): List<Solution>
        + findByBranchIdAndType(branchId: Long, type: SolutionType): List<Solution>
        + findFirstByBranchIdOrderByCreatedAtDesc(branchId: Long): Optional<Solution>
        + countByBranchId(branchId: Long): long
        + deleteById(id: Long): void
    }

    interface RouteRepository <<Repository>> {
        + save(entity: Route): Route
        + findById(id: Long): Optional<Route>
        + findBySolutionId(solutionId: Long): List<Route>
        + findByVehicleId(vehicleId: Long): List<Route>
        + deleteById(id: Long): void
    }

    interface RouteSegmentRepository <<Repository>> {
        + save(entity: RouteSegment): RouteSegment
        + findById(id: Long): Optional<RouteSegment>
        + findByRouteIdOrderBySequenceNumberAsc(routeId: Long): List<RouteSegment>
        + findByOrderId(orderId: Long): List<RouteSegment>
        + deleteById(id: Long): void
    }
}

' ============================================
' RELATIONSHIP: REPOSITORY MANAGES ENTITY
' ============================================
BranchRepository ..> Branch : manages
UserRepository ..> User : manages
DepotRepository ..> Depot : manages
FleetRepository ..> Fleet : manages
VehicleRepository ..> Vehicle : manages
OrderRepository ..> Order : manages

OptimizationJobRepository ..> OptimizationJob : manages

SolutionRepository ..> Solution : manages
RouteRepository ..> Route : manages
RouteSegmentRepository ..> RouteSegment : manages

' ============================================
' NOTES
' ============================================

legend right
    **Repository naming conventions:**
    • findBy* - Query methods
    • existsBy* - Boolean checks
    • countBy* - Count queries
    • deleteBy* - Bulk deletes

    **NEW in this version:**
    • OptimizationJobRepository
    • Job-specific query methods
    • Solution.findByJobId()
endlegend

@enduml