@startuml Service_Layer_V3
!include 00_Styling.puml
!include 02_Repository_Layer.puml
skinparam shadowing false
skinparam classAttributeIconSize 0

package "Service Layer" {

    class OptimizationJobService {
        + submitRoutePlanningJob(RoutePlanningRequest): OptimizationJobDTO
        + cancelJob(id, branchId): void
        + getCurrentRunningJob(branchId): Optional<OptimizationJobDTO>
        + getJobHistory(branchId, limit): List<OptimizationJobDTO>
        - prepareEngineRequest(job, request): EngineOptimizationRequest
        - estimateDuration(orderCount, vehicleCount): Integer
    }

    class OptimizationCallbackService {
        + handleCompletion(CompletionCallback): void
        + handleFailure(FailureCallback): void
        + handleProgressUpdate(ProgressCallback): void
        - saveSolutionAndRoutes(job, result): Solution
        - createRouteStop(route, stopData): RouteStop
    }

    class OrderImportService {
        + createOrdersByImportRequest(OrderImportRequest, branchId): ImportResultDTO
        + getAllOrdersPaginated(branchId, page, size): PageResponse<OrderDTO>
        + updateOrdersById(id, branchId, date, dto): OrderDTO
        - processManualEntries(text, branch, date): List<Order>
        - processFileEntries(file, branch, date): List<Order>
    }

    class VehicleService {
        + createVehicle(VehicleInputDTO, fleetId): VehicleDTO
        + updateVehicle(id, VehicleUpdateDTO): VehicleDTO
        + getAllVehiclesPaginated(branchId, page, size): PageResponse<VehicleDTO>
    }

    class VehicleTypeService {
        + createVehicleType(VehicleTypeInputDTO, branchId): VehicleTypeDTO
        + getVehicleTypesByBranchId(branchId): List<VehicleTypeDTO>
    }

    class DepotService {
        + createDepot(DepotInputDTO, branchId): DepotDTO
        + getAllDepotsByBranchId(branchId): List<DepotDTO>
    }

    class SolutionService {
        + getSolutionDetail(id): SolutionDetailResponseDTO
    }

    ' --- Helper/Infrastructure Services ---

    class GeocodingService {
        + geocode(address): GeocodeResult
    }

    class VehicleFeaturesService {
        + parseFeatures(json): VehicleFeaturesDTO
        + toJson(dto): String
        + getEmissionFactor(VehicleType): Double
    }

    class EmailService {
        + sendOptimizationSuccessEmail(user, job, solution): void
        + sendOptimizationFailureEmail(user, job, error): void
    }
}

' ============================================
' INTERNAL class DEPENDENCIES
' ============================================

' Job Service gọi API Client bên ngoài
OptimizationJobService --> "Integration" EngineApiClient

' Callback xong thì gửi Email
OptimizationCallbackService --> EmailService

' Import đơn hàng cần Geocoding để lấy tọa độ
OrderImportService --> GeocodingService

' Quản lý loại xe cần xử lý JSON features
VehicleTypeService --> VehicleFeaturesService
VehicleService --> VehicleTypeService

' OptimizationJob cần mapper config
OptimizationJobService --> OptimizationConfigMapper

' ============================================
' NOTES
' ============================================

note top of OptimizationJobService
  **Logic đặc trưng:**
  - Chuyển đổi Request người dùng 
    thành Request cho Engine.
  - Serialize dữ liệu input vào DB 
    để hỗ trợ tính năng Retry.
end note

note top of OptimizationCallbackService
  **Xử lý bất đồng bộ:**
  - Được gọi bởi CallbackController.
  - Phân tích JSON kết quả từ Engine 
    để map vào Solution/Route/RouteStop.
  - Sử dụng @Transactional để đảm bảo 
    tính toàn vẹn dữ liệu kết quả.
end note

note right of OrderImportService
  **Cơ chế Import:**
  - Hỗ trợ cả File (Excel/CSV) và Text Area.
  - Gọi GeocodingService cho từng dòng 
    để xác định vị trí trên bản đồ.
end note

legend right
    **Nguyên tắc thiết kế:**
    • **Stateless:** Các Service không lưu trạng thái.
    • **Transaction:** Xử lý @Transactional tại tầng Service.
    • **DTO Separation:** Controller nhận DTO -> Service xử lý Entity -> Mapper trả về DTO.
endlegend

@enduml