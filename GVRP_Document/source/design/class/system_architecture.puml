@startuml VRP_High_Level_Architecture

title VRP System - High-Level Architecture Design

!define RECTANGLE class

skinparam componentStyle rectangle
skinparam backgroundColor #FFFFFF
skinparam component {
    BackgroundColor<<Frontend>> LightBlue
    BackgroundColor<<EntryService>> LightGreen
    BackgroundColor<<EngineService>> LightYellow
    BackgroundColor<<External>> LightCoral
    BackgroundColor<<Storage>> Wheat
    BorderColor Black
    ArrowColor Black
}

' ============================================
' ACTORS
' ============================================
actor "Planner\nUser" as Planner
actor "Customer\nUser" as Customer

' ============================================
' FRONTEND LAYER
' ============================================
package "Presentation Layer" {
    component "Web Frontend\n(React/Vue)" as WebUI <<Frontend>> {
        [Map Viewer]
        [Order Manager]
        [Route Planner]
        [Solution History]
        [Analytics Dashboard]
    }
}

' ============================================
' ENTRY SERVICE (Main Backend)
' ============================================
package "Entry Service\n(Spring Boot - Port 8080)" <<EntryService>> {

    ' API Layer
    component "API Gateway Layer" as APILayer {
        [REST Controllers]
        [Authentication Filter]
        [Authorization Filter]
        [Request Validator]
    }

    ' Business Layer
    component "Business Logic Layer" as BusinessLayer {
        [Depot Service]
        [Fleet Service]
        [Order Import Service]
        [Solution Planning Service]
        [Solution Import/Export Service]
        [Solution Analysis Service]
        [Email Service]
    }

    ' Integration Layer
    component "Integration Layer" as IntegrationLayer {
        [Engine Client]
        [Email Client]
        [File Parser]
        [File Generator]
    }

    ' Data Access Layer
    component "Data Access Layer" as DataLayer {
        [JPA Repositories]
        [Hibernate Spatial]
        [Transaction Manager]
    }
}

' ============================================
' ENGINE SERVICE (Optimization)
' ============================================
package "Engine Service\n(Python/Java - Port 8081)" <<EngineService>> {

    component "Engine API" as EngineAPI {
        [Optimization Endpoint]
        [Health Check]
        [Status Monitor]
    }

    component "Optimization Engine" as OptEngine {
        [VRP Solver]
        [Route Calculator]
        [Constraint Handler]
        [Algorithm Selector]
    }

    component "Algorithm Implementations" as Algorithms {
        [GraphHopper Jsprit]
        [OR-Tools]
        [Custom Genetic Algorithm]
        [Tabu Search]
    }
}

' ============================================
' DATA STORAGE
' ============================================
package "Data Storage Layer" <<Storage>> {
    database "MySQL Database\n(with Spatial Extension)" as MySQL {
        [Branches]
        [Users]
        [Depots (POINT)]
        [Vehicles]
        [Orders (POINT)]
        [Solutions]
        [Routes]
        [RouteSegments]
    }

    storage "File Storage\n(Optional)" as FileStorage {
        [Uploaded CSVs]
        [Exported Reports]
        [Generated PDFs]
    }
}

' ============================================
' EXTERNAL SERVICES
' ============================================
package "External Services" <<External>> {
    component "Email Server\n(SMTP)" as EmailServer
    component "Map Provider\n(OpenStreetMap/Google)" as MapProvider
    component "Geocoding API\n(Optional)" as Geocoding
}

' ============================================
' RELATIONSHIPS - USER TO FRONTEND
' ============================================
Planner --> WebUI : HTTPS
Customer --> WebUI : HTTPS

' ============================================
' RELATIONSHIPS - FRONTEND TO ENTRY SERVICE
' ============================================
WebUI --> APILayer : REST API\n(HTTPS)

note right of WebUI
    Frontend communicates với
    Entry Service qua REST APIs:

    • GET /api/orders
    • POST /api/solutions/plan
    • GET /api/solutions/history
    • POST /api/solutions/export
    • POST /api/solutions/import
end note

' ============================================
' RELATIONSHIPS - ENTRY SERVICE INTERNAL
' ============================================
APILayer --> BusinessLayer : "Internal Calls"
BusinessLayer --> IntegrationLayer : "Integration"
BusinessLayer --> DataLayer : "Data Access"

' ============================================
' RELATIONSHIPS - ENTRY SERVICE TO STORAGE
' ============================================
DataLayer --> MySQL : JDBC\n(Connection Pool)
IntegrationLayer --> FileStorage : "File I/O"

note bottom of MySQL
    MySQL with Spatial Extensions:
    • POINT data type for locations
    • ST_Distance() for geo queries
    • Indexes on spatial columns
end note

' ============================================
' RELATIONSHIPS - ENTRY ↔ ENGINE SERVICE
' ============================================
IntegrationLayer --> EngineAPI : HTTP/gRPC\n(Async)

note on link
    Service Communication:

    Protocol: HTTP REST / gRPC
    Pattern: Request-Response
    Timeout: 15 minutes

    Request:
    {
      "depots": [...],
      "vehicles": [...],
      "orders": [...],
      "constraints": {...}
    }

    Response:
    {
      "routes": [...],
      "totalDistance": X,
      "totalCO2": Y,
      "status": "OPTIMAL"
    }
end note

' ============================================
' RELATIONSHIPS - ENGINE SERVICE INTERNAL
' ============================================
EngineAPI --> OptEngine : "Process Request"
OptEngine --> Algorithms : "Select & Execute"

' ============================================
' RELATIONSHIPS - ENTRY SERVICE TO EXTERNAL
' ============================================
IntegrationLayer --> EmailServer : SMTP\n(TLS)
WebUI --> MapProvider : HTTPS\n(Map Tiles)
IntegrationLayer --> Geocoding : HTTPS\n(Optional)

' ============================================
' USE CASE MAPPING
' ============================================
note top of BusinessLayer
    Use Case Mapping:

    VRP-001: Nhập dữ liệu
    → Depot/Fleet/Order Services
    → File Parser

    VRP-002: Optimization
    → Solution Planning Service
    → Engine Client → Engine Service
    → Email Service

    VRP-003: Export Solution
    → Solution Export Service
    → File Generator

    VRP-004: Import Solution
    → Solution Import Service
    → File Parser

    VRP-005: Analyze & Compare
    → Solution Analysis Service
end note

' ============================================
' DEPLOYMENT NOTES
' ============================================
note bottom of EngineAPI
    Engine Service có thể deploy:
    • Cùng server (monolith)
    • Separate container (microservice)
    • Separate server (distributed)
    • Cloud function (serverless)

    Recommend: Docker container
    với horizontal scaling
end note

' ============================================
' LEGEND
' ============================================
legend right
    |<back:LightBlue>   </back>| Frontend Components |
    |<back:LightGreen>  </back>| Entry Service |
    |<back:LightYellow> </back>| Engine Service |
    |<back:LightCoral>  </back>| External Services |
    |<back:Wheat>       </back>| Data Storage |

    **Architecture Style:**
    • Entry Service: Layered Architecture
    • Engine Service: Modular/Plugin Architecture
    • Communication: REST API / gRPC
    • Database: Relational with Spatial Extension

    **Key Design Decisions:**
    1. Separation of Entry vs Engine services
    2. Async optimization with email notification
    3. Multi-tenancy via Branch isolation
    4. Geospatial data with POINT type
    5. File-based import/export
endlegend

@enduml