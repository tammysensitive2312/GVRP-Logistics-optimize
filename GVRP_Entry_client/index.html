<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VRP System - Vehicle Route Planning</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="styles/main.css">

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

  <script src="scripts/auth.js"></script>
  <script src="scripts/api/api.js"></script>
  <script src="scripts/api/solution-api.js"></script>
  <script src="scripts/api/query-keys.js"></script>

  <script type="module" src="scripts/components/UI%20Components/sidebar.js"></script>
  <script type="module" src="scripts/components/UI%20Components/navbar.js"></script>
  <script type="module" src="scripts/components/UI%20Components/resizable-divider.js"></script>
  <script type="module" src="scripts/components/UI%20Components/orders-table.js"></script>
  <script type="module" src="scripts/components/UI%20Components/orders-filters.js"></script>

  <script type="module" src="scripts/components/Form%20Components/depot-form.js"></script>
  <script type="module" src="scripts/components/Form%20Components/fleet-form.js"></script>
  <script type="module" src="scripts/components/Form%20Components/vehicle-type-form.js"></script>
  <script type="module" src="scripts/components/Form%20Components/vehicle-card.js"></script>
  <script type="module" src="scripts/components/Form%20Components/import-modal.js"></script>
  <script type="module" src="scripts/components/Form%20Components/edit-order-modal.js"></script>
  <script type="module" src="scripts/components/Form%20Components/route-planning-modal.js"></script>
  <script type="module" src="scripts/components/Form%20Components/job-monitoring-modal.js"></script>
  <script type="module" src="scripts/components/Form%20Components/background-job-modal.js"></script>
  <script type="module" src="scripts/components/Solution%20Views/solution-view.js"></script>
  <script type="module" src="scripts/components/Admin/vehicle-manager.js"></script>
  <script type="module" src="scripts/components/Admin/vehicle-type-manager.js"></script>
  <script type="module" src="scripts/components/screens/admin-settings.js"></script>

  <script type="module" src="scripts/components/Map%20Components/depot-map.js"></script>
  <script type="module" src="scripts/components/Map%20Components/main-map.js"></script>

  <script type="module" src="scripts/utils/toast.js"></script>
  <script type="module" src="scripts/utils/loading.js"></script>
  <script type="module" src="scripts/utils/validation.js"></script>
  <script type="module" src="scripts/utils/dom-helpers.js"></script>

  <script type="module" src="scripts/core/state.js"></script>
  <script type="module" src="scripts/core/router.js"></script>

  <script type="module" src="scripts/lib/query-cache.js"></script>
  <script type="module" src="scripts/lib/query-helpers.js"></script>

  <script type="module" src="scripts/persistence-manager.js"></script>
  <script type="module" src="scripts/app.js"></script>
</head>
<body>
<!-- ============================================ -->
<!-- SCREEN 1: DEPOT SETUP -->
<!-- ============================================ -->
<div id="screen-depot-setup" class="screen active">
  <div class="setup-container">
    <div class="setup-header">
      <h1>ğŸ¢ Thiáº¿t láº­p Depot - Kho hÃ ng</h1>
      <p>Vui lÃ²ng chá»n vá»‹ trÃ­ kho hÃ ng cá»§a báº¡n trÃªn báº£n Ä‘á»“</p>
    </div>

    <form id="depot-form" class="setup-form">
      <!-- TÃªn Depot -->
      <div class="form-group">
        <label for="depot-name">TÃªn Depot <span class="required">*</span></label>
        <input
                type="text"
                id="depot-name"
                name="name"
                placeholder="VÃ­ dá»¥: Kho HÃ  Ná»™i"
                maxlength="100"
                required
        />
      </div>

      <!-- Interactive Map -->
      <div class="form-group">
        <label>Vá»‹ trÃ­ Depot <span class="required">*</span></label>
        <div id="depot-map" class="setup-map"></div>
        <p class="form-hint">
          ğŸ’¡ Click vÃ o báº£n Ä‘á»“ Ä‘á»ƒ chá»n vá»‹ trÃ­ kho hÃ ng cá»§a báº¡n
        </p>
      </div>

      <!-- Auto-filled Location Info -->
      <div class="form-group">
        <label for="depot-address">Äá»‹a chá»‰</label>
        <input
                type="text"
                id="depot-address"
                name="address"
                placeholder="Click vÃ o báº£n Ä‘á»“ Ä‘á»ƒ tá»± Ä‘á»™ng Ä‘iá»n Ä‘á»‹a chá»‰"
                readonly
        />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="depot-lat">Latitude</label>
          <input
                  type="text"
                  id="depot-lat"
                  name="latitude"
                  placeholder="21.028511"
                  readonly
          />
        </div>
        <div class="form-group">
          <label for="depot-lng">Longitude</label>
          <input
                  type="text"
                  id="depot-lng"
                  name="longitude"
                  placeholder="105.804817"
                  readonly
          />
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="DepotForm.reset()">
          Há»§y
        </button>
        <button type="submit" class="btn btn-primary">
          LÆ°u Depot
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ============================================ -->
<!-- SCREEN 1.5: VEHICLE TYPE SETUP -->
<!-- ============================================ -->
<div id="screen-vehicle-type-setup" class="screen">
  <div class="setup-container">
    <div class="setup-header">
      <h1>ğŸšš Thiáº¿t láº­p Loáº¡i xe</h1>
      <p>ThÃªm cÃ¡c loáº¡i xe mÃ  Ä‘á»™i cá»§a báº¡n sá»­ dá»¥ng</p>
    </div>

    <!-- Existing Vehicle Types -->
    <div class="existing-types-section">
      <h3>CÃ¡c loáº¡i xe hiá»‡n cÃ³</h3>
      <div id="vehicle-types-list" class="vehicle-types-grid">
        <div class="loading-message">Äang táº£i...</div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Add New Vehicle Type Form -->
    <h3>ThÃªm loáº¡i xe má»›i</h3>
    <form id="vehicle-type-form" class="setup-form">
      <div class="form-group">
        <label for="vtype-name">TÃªn loáº¡i xe <span class="required">*</span></label>
        <input type="text" id="vtype-name" placeholder="VD: Xe táº£i 5 táº¥n" required />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="vtype-capacity">Táº£i trá»ng (kg) <span class="required">*</span></label>
          <input type="number" id="vtype-capacity" min="1" placeholder="5000" required />
        </div>

        <div class="form-group">
          <label for="vtype-emission-factor">Emission Factor</label>
          <input type="number" id="vtype-emission-factor" step="0.1" placeholder="12.3" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="vtype-fixed-cost">Chi phÃ­ cá»‘ Ä‘á»‹nh (VND) <span class="required">*</span></label>
          <input type="number" id="vtype-fixed-cost" min="0" step="1000" placeholder="50000" required />
        </div>

        <div class="form-group">
          <label for="vtype-cost-per-km">Chi phÃ­/km (VND) <span class="required">*</span></label>
          <input type="number" id="vtype-cost-per-km" min="0" step="100" placeholder="5000" required />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="vtype-cost-per-hour">Chi phÃ­/giá» (VND) <span class="required">*</span></label>
          <input type="number" id="vtype-cost-per-hour" min="0" step="1000" placeholder="4000" required />
        </div>

        <div class="form-group">
          <label for="vtype-max-distance">QuÃ£ng Ä‘Æ°á»ng tá»‘i Ä‘a (km)</label>
          <input type="number" id="vtype-max-distance" min="0" step="1" placeholder="300" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="vtype-max-duration">Thá»i gian tá»‘i Ä‘a (phÃºt)</label>
          <input type="number" id="vtype-max-duration" min="0" step="1" placeholder="480" />
        </div>
        <div class="form-group">
          <!-- Empty spacer -->
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="Router.goTo(Router.SCREENS.DEPOT_SETUP)">
          â† Quay láº¡i
        </button>
        <button type="submit" class="btn btn-primary">
          + ThÃªm loáº¡i xe
        </button>
        <button type="button" class="btn btn-success" onclick="VehicleTypeForm.continueToFleet()">
          Tiáº¿p tá»¥c â†’
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ============================================ -->
<!-- SCREEN 2: FLEET SETUP -->
<!-- ============================================ -->
<div id="screen-fleet-setup" class="screen">
  <div class="setup-container">
    <div class="setup-header">
      <h1>ğŸšš Thiáº¿t láº­p Äá»™i xe</h1>
      <p>ThÃªm thÃ´ng tin vá» Ä‘á»™i xe vÃ  phÆ°Æ¡ng tiá»‡n cá»§a báº¡n</p>
    </div>

    <form id="fleet-form" class="setup-form">
      <!-- TÃªn Ä‘á»™i xe -->
      <div class="form-group">
        <label for="fleet-name">TÃªn Ä‘á»™i xe <span class="required">*</span></label>
        <input
                type="text"
                id="fleet-name"
                name="fleetName"
                placeholder="VÃ­ dá»¥: Äá»™i xe giao hÃ ng ná»™i thÃ nh"
                required
        />
      </div>

      <!-- Vehicle List -->
      <div class="form-group">
        <div class="section-header">
          <label>Danh sÃ¡ch Xe <span class="required">*</span></label>
          <button type="button" class="btn btn-sm btn-success" onclick="FleetForm.addVehicle()">
            + ThÃªm xe
          </button>
        </div>

        <!-- Available Depots Info -->
        <div id="depots-info" class="depots-info-box" style="display: none;">
          <strong>ğŸ“ Depots cÃ³ sáºµn:</strong>
          <div id="depots-list-info"></div>
        </div>

        <div id="vehicle-types-info" class="vehicle-types-info-box" style="display: none;">
          <strong>ğŸšš CÃ¡c loáº¡i xe cÃ³ sáºµn:</strong>
          <div id="vehicle-types-list-info"></div>
        </div>

        <div id="vehicles-container" class="vehicles-container">
          <!-- Vehicle items will be added here dynamically -->
        </div>
      </div>

      <!-- Fleet Summary -->
      <div class="fleet-summary">
        <div class="summary-item">
          <span class="summary-label">ğŸ“Š Tá»•ng sá»‘ xe:</span>
          <span class="summary-value" id="total-vehicles">0</span>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="Router.goTo(Router.SCREENS.DEPOT_SETUP)">
          â† Quay láº¡i
        </button>
        <button type="submit" class="btn btn-primary">
          LÆ°u Äá»™i xe
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ============================================ -->
<!-- SCREEN 3: MAIN SCREEN (Dashboard) -->
<!-- ============================================ -->
<div id="screen-main" class="screen">
  <!-- Top Navbar -->
  <nav class="navbar">
    <div class="navbar-left">
      <button class="btn-icon" onclick="Sidebar.toggle()">â˜°</button>
      <div class="brand">
        <span class="brand-icon">ğŸ“¦</span>
        <span class="brand-name">VRP Systemâ„¢</span>
      </div>
    </div>

    <div class="navbar-center">
      <button class="nav-menu-item active">Dashboard</button>
      <button class="nav-menu-item" onclick="alert('Analysis screen - VRP-006')">Analysis</button>
      <button class="nav-menu-item" onclick="alert('History screen - VRP-005')">History</button>
    </div>

    <div class="navbar-right">
      <div class="user-menu" id="userMenuDropdown">
        <span class="user-avatar">ğŸ‘¤</span>
        <span class="user-name">Admin</span>

        <button class="btn-icon btn-dropdown-trigger" onclick="event.stopPropagation(); Navbar.toggleDropdown('userMenuDropdown')">
          â–¼
        </button>

        <div class="dropdown-content">
          <a href="#" onclick="event.preventDefault(); alert('Profile - Coming soon!')">
            ğŸ‘¤ Profile
          </a>
          <a href="#" onclick="event.preventDefault(); Router.goTo('screen-admin-settings')">
            âš™ï¸ Administrator
          </a>
          <div class="divider"></div>
          <a href="#" onclick="event.preventDefault(); Navbar.handleLogout()" style="color: var(--danger-red);">
            ğŸšª Logout
          </a>
        </div>
      </div>
    </div>
</nav>

  <!-- Main Content -->
  <div class="main-layout">
    <!-- Left Sidebar -->
    <aside id="main-sidebar" class="sidebar">
      <!-- Stats Cards (Horizontal) -->
      <div class="stats-section">
        <h3 class="section-title">ğŸ“Š TODAY'S STATS</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number">0</div>
            <div class="stat-label">Scheduled</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">0</div>
            <div class="stat-label">Completed</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">0</div>
            <div class="stat-label">Total</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">0</div>
            <div class="stat-label">Unassigned</div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="sidebar-section">
        <div class="section-header" onclick="Sidebar.toggleSection('depots-content', this)">
          <h3 class="section-title">ğŸ“ DEPOTS (<span id="depot-count">0</span>)</h3>
          <span class="toggle-icon">â–¼</span>
        </div>

        <div class="section-content expanded" id="depots-content">
          <div id="depots-list" class="compact-list">
            <div class="empty-message">Loading depots...</div>
          </div>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="section-header" onclick="Sidebar.toggleSection('vehicles-content', this)">
          <h3 class="section-title">ğŸšš VEHICLES (<span id="vehicle-count">0</span>)</h3>
          <span class="toggle-icon">â–¼</span>
        </div>

        <div class="section-content expanded" id="vehicles-content">
          <div id="vehicles-list" class="compact-list">
            <div class="empty-message">Loading vehicles...</div>
          </div>
        </div>
      </div>

      <!-- Collapse Button -->
      <button class="btn-collapse" onclick="Sidebar.toggle()">
        â—„ Hide Sidebar
      </button>
    </aside>

    <!-- Main Content Area (70%) -->
    <main class="main-content">
      <!-- Map View -->
      <div class="map-container" id="map-section">
        <div id="main-map" class="main-map"></div>
      </div>

      <!-- Resizable Divider -->
      <div class="resize-divider" id="resize-divider">
        <div class="resize-handle">
          <span class="resize-icon">â‹®</span>
        </div>
      </div>

      <!-- Orders Table -->
      <div class="table-container" id="table-section">

        <div class="tab-switcher">
          <button class="tab-btn active" data-tab="orders-tab" onclick="switchContentTab('orders-tab')">Orders</button>
          <button class="tab-btn" data-tab="route-tab" onclick="switchContentTab('route-tab')">Route</button>
          <button class="tab-btn" data-tab="timeline-tab" onclick="switchContentTab('timeline-tab')">Timeline</button>
        </div>

        <div class="tab-content-item active" id="orders-tab">

          <div class="table-header">
            <div class="table-actions-row">
              <button class="btn btn-primary" onclick="openAddOrderModal()">
                <span>+</span> Add Order
              </button>
              <button class="btn btn-secondary" onclick="openImportModal()">
                <span>ğŸ“¥</span> Import Orders
              </button>
              <button class="btn btn-secondary" onclick="OrdersTable.selectAllOrdersInDatabase()">
                <span>â˜‘ï¸</span> Select All Orders
              </button>
              <button class="btn btn-success" id="btn-plan-routes"  onclick="openRoutePlanningModal()" disabled>
                <span>ğŸ“Š</span> Plan Routes
                <span class="badge" id="selected-count">0</span>
              </button>
              <div class="dropdown">
                <button class="btn btn-menu">â‹®</button>
                <div class="dropdown-content">
                  <a href="#" onclick="exportOrders()">Export to CSV</a>
                  <a href="#" onclick="deleteSelectedOrders()">Delete Selected</a>
                  <a href="#" onclick="bulkEditOrders()">Bulk Edit</a>
                </div>
              </div>
            </div>
            <div class="table-filters-row">
              <div class="filter-group">
                <label>ğŸ“…</label>
                <input type="date" id="filter-date" value="2025-10-21" onchange="loadOrders()" />
              </div>
              <div class="filter-group">
                <label>Status:</label>
                <select id="filter-status" onchange="applyFilters()">
                  <option value="">All</option>
                  <option value="SCHEDULED">Scheduled</option>
                  <option value="ON_ROUTE">On Route</option>
                  <option value="COMPLETED">Completed</option>
                  <option value="FAILED">Failed</option>
                </select>
              </div>
              <div class="filter-group search">
                <span>ğŸ”</span>
                <input type="text" id="filter-search" placeholder="Search orders..." oninput="applyFilters()" />
              </div>
              <button class="btn btn-text" onclick="clearFilters()">Clear</button>
              <button class="btn btn-secondary" onclick="refreshAllData()" title="Refresh data from server">
                ğŸ”„
              </button>
            </div>
          </div>


          <div class="table-content">
            <table id="orders-table" class="data-table">
              <thead>
              <tr>
                <th><input type="checkbox" id="select-all" onchange="toggleSelectAll()" /></th>
                <th>Order Code</th>
                <th>Customer</th>
                <th>Address</th>
                <th>Priority</th>
                <th>Time window</th>
                <th>Capacity</th>
                <th>Time service</th>
                <th>Notes</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
              </thead>
              <tbody id="orders-tbody">
              </tbody>
            </table>
          </div>

          <div class="table-footer">
            <!-- Left side: Info -->
            <div class="footer-info">
              <span>âœ… Selected: <strong id="footer-selected">0</strong> orders</span>
              <span class="separator">|</span>
              <span>Showing <strong id="footer-showing">0</strong> of <strong id="footer-total">0</strong> orders</span>
            </div>

            <!-- Center: Page size selector -->
            <div class="footer-controls">
              <label for="page-size-selector" class="page-size-label">
                Show:
                <select id="page-size-selector" class="page-size-select">
                  <option value="10" selected>10</option>
                  <option value="20">20</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>
                per page
              </label>
            </div>

            <!-- Right side: Pagination -->
            <div class="pagination">
              <!-- First & Previous buttons -->
              <button
                      id="btn-first-page"
                      class="btn-page"
                      onclick="firstPage()"
                      title="First page">
                Â«
              </button>
              <button
                      id="btn-prev-page"
                      class="btn-page"
                      onclick="previousPage()"
                      title="Previous page">
                â€¹
              </button>

              <!-- Page numbers container -->
              <div id="page-numbers" class="page-numbers">
                <!-- Page buttons will be inserted here by JavaScript -->
              </div>

              <!-- Next & Last buttons -->
              <button
                      id="btn-next-page"
                      class="btn-page"
                      onclick="nextPage()"
                      title="Next page">
                â€º
              </button>
              <button
                      id="btn-last-page"
                      class="btn-page"
                      onclick="lastPage()"
                      title="Last page">
                Â»
              </button>

              <!-- Page info -->
              <span class="page-info">
                Page <strong id="current-page">1</strong> of <strong id="total-pages">1</strong>
              </span>
            </div>
          </div>

        </div>

        <div class="tab-content-item" id="route-tab">
          <div class="route-planning-view">
            <h3>ğŸ—ºï¸ Route Planning & Optimization</h3>
            <p>Ná»™i dung hiá»ƒn thá»‹ cÃ¡c tuyáº¿n Ä‘Æ°á»ng Ä‘Ã£ Ä‘Æ°á»£c quy hoáº¡ch, báº£n Ä‘á»“ tÆ°Æ¡ng tÃ¡c, vÃ  danh sÃ¡ch Stops/Jobs.</p>
          </div>
        </div>

        <div class="tab-content-item" id="timeline-tab">
          <div class="timeline-view">
            <h3>ğŸ•’ Route Timeline (Gantt Chart)</h3>
            <p>Ná»™i dung hiá»ƒn thá»‹ biá»ƒu Ä‘á»“ Gantt, trá»±c quan hÃ³a lá»‹ch trÃ¬nh xe cháº¡y vÃ  thá»i gian phá»¥c vá»¥.</p>
          </div>
        </div>

      </div>

    </main>
  </div>
</div>


<!-- ============================================ -->
<!-- ROUTE PLANNING MODAL -->
<!-- ============================================ -->
<div id="modal-route-planning" class="modal">
  <div class="modal-content modal-large">
    <div class="modal-header">
      <h2>ğŸš€ Route Planning & Optimization</h2>
      <button class="btn-close" onclick="RoutePlanningModal.close()">âœ•</button>
    </div>

    <form id="route-planning-form" class="modal-body">
      <!-- Selection Summary -->
      <div class="form-section">
        <h3 class="form-section-title">ğŸ“Š Selection Summary</h3>

        <div class="summary-grid">
          <div class="summary-card">
            <div class="summary-icon">ğŸ“¦</div>
            <div class="summary-content">
              <div class="summary-label">Orders Selected</div>
              <div class="summary-value" id="selected-orders-count">0</div>
            </div>
          </div>

          <div class="summary-card">
            <div class="summary-icon">ğŸšš</div>
            <div class="summary-content">
              <div class="summary-label">Vehicles Selected</div>
              <div class="summary-value" id="selected-vehicles-count">0</div>
            </div>
          </div>

          <div class="summary-card">
            <div class="summary-icon">ğŸ“¦</div>
            <div class="summary-content">
              <div class="summary-label">Total Demand</div>
              <div class="summary-value"><span id="total-demand">0</span> kg</div>
            </div>
          </div>

<!--          <div class="summary-card">-->
<!--            <div class="summary-icon">ğŸ‹ï¸</div>-->
<!--            <div class="summary-content">-->
<!--              <div class="summary-label">Total Capacity</div>-->
<!--              <div class="summary-value"><span id="total-capacity">0</span> kg</div>-->
<!--            </div>-->
<!--          </div>-->
        </div>

<!--        <div class="capacity-bar">-->
<!--          <div class="capacity-bar-label">-->
<!--            <span>Capacity Utilization</span>-->
<!--            <span><strong id="capacity-utilization">0</strong>%</span>-->
<!--          </div>-->
<!--          <div class="capacity-bar-track">-->
<!--            <div class="capacity-bar-fill" id="capacity-bar-fill"></div>-->
<!--          </div>-->
<!--        </div>-->

<!--        <div id="capacity-warning" class="alert alert-warning" style="display: none;">-->
<!--          âš ï¸ Total demand exceeds capacity!-->
<!--        </div>-->
      </div>

      <!-- Optimization Preferences -->
      <div class="form-section">
        <h3 class="form-section-title">âš™ï¸ Optimization Preferences</h3>

        <!-- Optimization Goal -->
        <div class="form-group">
          <label for="optimization-goal">
            Optimization Goal <span class="required">*</span>
            <span class="tooltip-icon" title="Choose what to optimize">â„¹ï¸</span>
          </label>
          <select id="optimization-goal" required>
            <option value="MINIMIZE_COST">ğŸ’° Minimize Cost (Default)</option>
            <option value="MINIMIZE_DISTANCE">ğŸ›£ï¸ Minimize Distance</option>
            <option value="MINIMIZE_CO2">ğŸŒ± Minimize CO2 Emissions (Green)</option>
            <option value="BALANCED">âš–ï¸ Balanced (Cost + Distance + CO2)</option>
          </select>
          <div class="form-hint" id="goal-description">
            <!-- Will be populated by JS -->
          </div>
        </div>

        <!-- Optimization Speed -->
        <div class="form-group">
          <label for="optimization-speed">
            Optimization Speed <span class="required">*</span>
            <span class="tooltip-icon" title="Trade-off between speed and quality">â„¹ï¸</span>
          </label>
          <select id="optimization-speed" required>
            <option value="FAST">âš¡ Fast (2-3 minutes, acceptable quality)</option>
            <option value="NORMAL" selected>ğŸ¯ Normal (5-8 minutes, good quality) - Recommended</option>
            <option value="HIGH_QUALITY">ğŸ’ High Quality (10-15 minutes, best quality)</option>
          </select>
          <div class="form-hint">
            Longer optimization time generally produces better routes
          </div>
        </div>

        <!-- Time Window Mode -->
        <div class="form-group">
          <label for="time-window-mode">
            Time Window Mode
            <span class="tooltip-icon" title="How strictly to enforce time windows">â„¹ï¸</span>
          </label>
          <select id="time-window-mode">
            <option value="STRICT" selected>ğŸ”’ Strict (Must follow time windows exactly)</option>
            <option value="FLEXIBLE">ğŸ”“ Flexible (Allow violations with penalty)</option>
          </select>
        </div>

        <!-- Advanced Options -->
        <div class="form-group">
          <label>Advanced Options</label>

          <div class="checkbox-group">
            <label class="checkbox-label">
              <div class="checkbox-row">
                <input type="checkbox" id="allow-unassigned" />
                <span>Allow Unassigned Orders</span>
              </div>
              <span class="form-hint">Allow some orders to be unassigned if they cannot be served efficiently</span>
            </label>

            <label class="checkbox-label">
              <div class="checkbox-row">
                <input type="checkbox" id="enable-pareto" />
                <span>Enable Pareto Analysis</span>
              </div>
              <span class="form-hint">Generate multiple solutions for trade-off analysis (for research)</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Estimated Time -->
      <div class="info-box">
        <div class="info-icon">â±ï¸</div>
        <div class="info-content">
          <strong>Estimated Processing Time:</strong>
          <span id="estimated-time">5-8 minutes</span>
          <p>You can monitor progress in real-time and cancel anytime.</p>
        </div>
      </div>
    </form>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="RoutePlanningModal.close()">
        Cancel
      </button>
      <button type="submit" form="route-planning-form" class="btn btn-primary">
        ğŸš€ Start Optimization
      </button>
    </div>
  </div>
</div>

<!-- ============================================ -->
<!-- JOB MONITORING MODAL -->
<!-- ============================================ -->
<div id="modal-job-monitoring" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ğŸ”„ Optimization Job <span id="job-id">#1</span></h2>
      <button class="btn-close" onclick="closeJobMonitoringModal()">âœ•</button>
    </div>

    <div class="modal-body">
      <!-- Job Status -->
      <div class="job-status-section">
        <div class="status-row">
          <span class="status-label">Status:</span>
          <span class="status-badge" id="job-status-badge">RUNNING</span>
          <span id="job-status">ğŸ”„ Running</span>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container">
          <div class="progress-label">
            <span>Progress</span>
            <span id="job-progress-text">0%</span>
          </div>
          <div class="progress-bar-track">
            <div class="progress-bar-fill" id="job-progress-bar" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Result Section (shown when completed) -->
      <div id="job-result-section" style="display: none;">
        <h3>ğŸ“Š Optimization Result</h3>

        <div class="result-grid">
          <!-- Row 1: Primary Metrics -->
          <div class="result-card">
            <div class="result-label">ğŸ’° Total Cost</div>
            <div class="result-value">
              <span id="result-total-cost">â€”</span> VND
            </div>
          </div>

          <div class="result-card">
            <div class="result-label">ğŸ›£ï¸ Total Distance</div>
            <div class="result-value">
              <span id="result-total-distance">â€”</span> km
            </div>
          </div>

          <div class="result-card">
            <div class="result-label">â±ï¸ Total Time</div>
            <div class="result-value">
              <span id="result-total-time">â€”</span> hours
            </div>
          </div>

          <div class="result-card">
            <div class="result-label">ğŸŒ± Total CO2</div>
            <div class="result-value">
              <span id="result-total-co2">â€”</span> kg
            </div>
          </div>

          <!-- Row 2: Secondary Metrics -->
          <div class="result-card">
            <div class="result-label">ğŸšš Routes</div>
            <div class="result-value" id="result-routes-count">â€”</div>
          </div>

          <div class="result-card result-card-success">
            <div class="result-label">âœ… Served Orders</div>
            <div class="result-value" id="result-assigned-orders">â€”</div>
          </div>

          <div class="result-card result-card-warning">
            <div class="result-label">âŒ Unserved Orders</div>
            <div class="result-value" id="result-unassigned-orders">â€”</div>
          </div>
        </div>

        <!-- Unassigned Warning -->
        <div id="unassigned-warning" class="alert alert-warning" style="display: none;">
          <strong>âš ï¸ Warning:</strong> Some orders could not be assigned to any route.
          This may be due to capacity constraints, time window conflicts, or vehicle limitations.
          <br>
          <small>Review the solution details to see which orders were not served.</small>
        </div>

        <!-- Loading State (shown while fetching solution) -->
        <div id="solution-loading" class="loading-state" style="display: none;">
          <div class="loading-spinner-small"></div>
          <span>Loading solution details...</span>
        </div>
      </div>

      <!-- Error Section (shown when failed) -->
      <div id="job-error-section" class="alert alert-danger" style="display: none;">
        <strong>âŒ Error:</strong>
        <p id="job-error-message"></p>
      </div>
    </div>

    <div class="modal-footer">
      <button
              type="button"
              class="btn btn-danger"
              id="btn-cancel-job"
              onclick="cancelCurrentJob()">
        ğŸš« Cancel Job
      </button>
      <button
              type="button"
              class="btn btn-secondary"
              onclick="closeJobMonitoringModal()">
        Close
      </button>
      <button
              type="button"
              class="btn btn-primary"
              id="btn-view-result">
        View Result
      </button>
    </div>
  </div>
</div>

<!-- ============================================ -->
<!-- BACKGROUND JOB CONFIRMATION MODAL -->
<!-- For NORMAL & HIGH_QUALITY modes -->
<!-- ============================================ -->
<div id="modal-background-job" class="modal">
  <div class="modal-content modal-medium">
    <div class="modal-header">
      <h2>ğŸ“§ Job Running in Background</h2>
      <button class="btn-close" onclick="closeBackgroundJobModal()">âœ•</button>
    </div>

    <div class="modal-body">
      <div class="success-icon-large">âœ…</div>

      <div class="text-center" style="margin: 2rem 0;">
        <h3>Optimization Job <span id="bg-job-id">#123</span> Created Successfully!</h3>
        <p style="color: #666; margin-top: 0.5rem;">
          Your optimization job is now running in the background.
        </p>
      </div>

      <div class="info-box info-box-blue">
        <div class="info-icon">ğŸ“§</div>
        <div class="info-content">
          <strong>Email Notification</strong>
          <p>You will receive an email at <strong id="bg-job-email">your@email.com</strong> when the optimization is complete.</p>
          <p>The email will contain:</p>
          <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
            <li>Optimization results summary</li>
            <li>Direct link to view detailed solution</li>
            <li>Download links for route data</li>
          </ul>
        </div>
      </div>

      <div class="divider"></div>

      <div class="text-center">
        <p style="color: #666; font-size: 0.95rem;">
          â±ï¸ Estimated completion time: <strong>5-15 minutes</strong>
        </p>
        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">
          You can safely close this tab and continue working.
          Check <strong>Job History</strong> to monitor all your jobs.
        </p>
      </div>
    </div>

    <div class="modal-footer">
      <button
              type="button"
              class="btn btn-secondary"
              onclick="closeBackgroundJobModal()">
        Close
      </button>
      <button
              type="button"
              class="btn btn-primary"
              onclick="viewJobHistoryFromBg()">
        ğŸ“œ View Job History
      </button>
    </div>
  </div>
</div>

<!-- Update Route Planning Modal to show warning mode info -->
<!-- Add this inside the route-planning-form, after estimated time -->
<div id="waiting-mode-info" style="display: none;">
  <!-- Will be populated by JavaScript based on speed selection -->
</div>

<!-- ============================================ -->
<!-- SCREEN 4: IMPORT ORDERS MODAL -->
<!-- ============================================ -->
<div id="modal-import" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ğŸ“¥ Import Orders</h2>
      <button class="btn-close" onclick="closeImportModal()">âœ•</button>
    </div>

    <form id="import-form" class="modal-body">
      <!-- Import Method Selection (Horizontal) -->
      <div class="form-group">
        <div class="import-method-grid">
          <div class="import-method-label">
            <label>Import method:</label>
          </div>
          <div class="import-method-options">
            <label class="radio-label-inline">
              <input type="radio" name="import-method" value="file" checked onchange="toggleImportMethod()" />
              <span>ğŸ“ File (CSV/Excel)</span>
            </label>
            <label class="radio-label-inline">
              <input type="radio" name="import-method" value="text" onchange="toggleImportMethod()" />
              <span>ğŸ“ Raw Text</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Overwrite Checkbox (Right below import method) -->
      <div class="form-group">
        <div class="import-method-grid">
          <div class="import-method-label">
            <label>Overwrite existing:</label>
          </div>
          <div class="import-method-options">
            <label class="checkbox-label-inline">
              <input type="checkbox" id="import-overwrite" />
            </label>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- File Upload Section -->
      <div id="import-file-section" class="import-section">
        <div class="form-group">
          <label>Upload File</label>
          <div class="file-upload-zone" id="file-drop-zone">
            <input type="file" id="import-file" accept=".csv,.xlsx" onchange="handleFileSelect(event)" hidden />
            <div class="upload-content">
              <div class="upload-icon">ğŸ“</div>
              <div class="upload-text">
                <p><strong>Click to select file</strong> or drag and drop</p>
                <p class="upload-hint">CSV or Excel files (max 10MB)</p>
              </div>
            </div>
            <div class="file-selected" id="file-selected" style="display: none;">
              <span class="file-name" id="file-name"></span>
              <button type="button" class="btn-remove" onclick="removeFile()">âœ•</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Text Input Section -->
      <div id="import-text-section" class="import-section" style="display: none;">
        <div class="form-group">
          <label>Order data</label>
          <div class="format-hint">
            <strong>Format:</strong> OrderCode|Name|Phone|Address|Demand|TWStart|TWEnd|Priority|Notes
          </div>
          <textarea
                  id="import-text"
                  rows="10"
                  placeholder="ORD001|John|0901234567|123 Main St|50.5|08:00|12:00|1|Handle with care&#10;ORD002|Jane|0912345678|456 Second Ave|30.0||||2|"
          ></textarea>
        </div>
      </div>

      <!-- Common Fields -->
      <div class="form-row">
        <div class="form-group">
          <label for="import-delivery-date">Delivery date <span class="required">*</span></label>
          <input type="date" id="import-delivery-date" required />
        </div>
        <div class="form-group">
          <label for="import-service-time">Service time (minutes) <span class="required">*</span></label>
          <input type="number" id="import-service-time" value="5" min="0" required />
        </div>
      </div>

      <!-- Helper Section -->
      <div class="help-section">
        <h4>ğŸ’¡ Hint:</h4>
        <ul>
          <li>CSV File: max 10MB</li>
          <li>Support UTF-8 encoding</li>
          <li>Template: <a href="#" onclick="downloadTemplate()">Download sample file</a></li>
        </ul>
      </div>
    </form>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeImportModal()">
        Cancel
      </button>
      <button type="button" class="btn btn-primary" onclick="submitImport()">
        Import
      </button>
    </div>
  </div>
</div>

<!-- ============================================ -->
<!-- EDIT ORDER MODAL -->
<!-- ============================================ -->
<div id="modal-edit-order" class="modal">
  <div class="modal-content modal-large">
    <div class="modal-header">
      <h2 class="modal-title">ğŸ“ Edit Order</h2>
      <button class="btn-close" onclick="EditOrderModal.close()">âœ•</button>
    </div>

    <form id="edit-order-form" class="modal-body">
      <!-- Basic Information -->
      <div class="form-section">
        <h3 class="form-section-title">ğŸ“‹ Basic Information</h3>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-order-code">Order Code <span class="required">*</span></label>
            <input type="text" id="edit-order-code" placeholder="ORD001" required />
          </div>

          <div class="form-group">
            <label for="edit-status">Status</label>
            <select id="edit-status">
              <option value="SCHEDULED">Scheduled</option>
              <option value="ON_ROUTE">On Route</option>
              <option value="COMPLETED">Completed</option>
              <option value="FAILED">Failed</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-customer-name">Customer Name <span class="required">*</span></label>
            <input type="text" id="edit-customer-name" placeholder="John Doe" required />
          </div>

          <div class="form-group">
            <label for="edit-customer-phone">Phone Number</label>
            <input type="tel" id="edit-customer-phone" placeholder="0901234567" />
          </div>
        </div>
      </div>

      <!-- Location -->
      <div class="form-section">
        <h3 class="form-section-title">ğŸ“ Location</h3>

        <div class="form-group">
          <label for="edit-address">Address <span class="required">*</span></label>
          <input type="text" id="edit-address" placeholder="123 Main Street" required />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-latitude">Latitude <span class="required">*</span></label>
            <input type="number" id="edit-latitude" step="any" placeholder="21.028511" required />
          </div>

          <div class="form-group">
            <label for="edit-longitude">Longitude <span class="required">*</span></label>
            <input type="number" id="edit-longitude" step="any" placeholder="105.804817" required />
          </div>
        </div>

        <button type="button" class="btn btn-secondary btn-sm" onclick="EditOrderModal.openLocationPicker()">
          ğŸ—ºï¸ Pick Location on Map
        </button>
      </div>

      <!-- Order Details -->
      <div class="form-section">
        <h3 class="form-section-title">ğŸ“¦ Order Details</h3>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-demand">Demand (kg) <span class="required">*</span></label>
            <input type="number" id="edit-demand" step="0.1" min="0.1" placeholder="50.5" required />
          </div>

          <div class="form-group">
            <label for="edit-service-time">Service Time (minutes) <span class="required">*</span></label>
            <input type="number" id="edit-service-time" min="0" value="5" required />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-priority">Priority (1-10)</label>
            <input type="number" id="edit-priority" min="1" max="10" value="5" />
          </div>

          <div class="form-group">
            <label for="edit-delivery-date">Delivery Date</label>
            <input type="date" id="edit-delivery-date" />
          </div>
        </div>
      </div>

      <!-- Time Windows -->
      <div class="form-section">
        <h3 class="form-section-title">â° Time Windows (Optional)</h3>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-time-window-start">Start Time</label>
            <input type="time" id="edit-time-window-start" placeholder="08:00" />
          </div>

          <div class="form-group">
            <label for="edit-time-window-end">End Time</label>
            <input type="time" id="edit-time-window-end" placeholder="12:00" />
          </div>
        </div>
      </div>

      <!-- Delivery Notes -->
      <div class="form-section">
        <h3 class="form-section-title">ğŸ“ Notes</h3>

        <div class="form-group">
          <label for="edit-delivery-notes">Delivery Notes</label>
          <textarea id="edit-delivery-notes" rows="3" placeholder="Special instructions..."></textarea>
        </div>
      </div>
    </form>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="EditOrderModal.close()">
        Cancel
      </button>
      <button type="submit" form="edit-order-form" class="btn btn-primary">
        ğŸ’¾ Save
      </button>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay" style="display: none;">
  <div class="loading-spinner"></div>
  <div class="loading-text">Äang xá»­ lÃ½...</div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast"></div>

<!-- ============================================ -->
<!-- SCREEN: ADMIN SETTINGS -->
<!-- ============================================ -->
<div id="screen-admin-settings" class="screen">
  <nav class="navbar">
    <div class="navbar-left">
      <button class="btn-icon" onclick="AdminSettings.toggleSidebar()">â˜°</button>
      <div class="brand">
        <span class="brand-icon">âš™ï¸</span>
        <span class="brand-name">Administrator</span>
      </div>
    </div>

    <div class="navbar-right">
      <button class="btn btn-secondary" onclick="Router.goTo(Router.SCREENS.MAIN)">
        â† Back to Dashboard
      </button>
    </div>
  </nav>

  <div class="admin-settings-layout">
    <!-- Sidebar -->
    <aside id="admin-sidebar" class="admin-sidebar">
      <div class="admin-sidebar-header">
        <h2>
          <span>âš™ï¸</span>
          Settings
        </h2>
      </div>

      <div class="admin-menu">
        <div class="admin-menu-item active" data-section="vehicle-types" onclick="AdminSettings.switchSection('vehicle-types')">
          <span class="icon">ğŸšš</span>
          <span class="label">Vehicle Types</span>
          <span class="badge" id="vehicle-types-count">0</span>
        </div>

        <div class="admin-menu-item" data-section="vehicles" onclick="AdminSettings.switchSection('vehicles')">
          <span class="icon">ğŸš—</span>
          <span class="label">Vehicles</span>
          <span class="badge" id="vehicles-count">0</span>
        </div>

        <div class="admin-menu-item" data-section="depots" onclick="AdminSettings.switchSection('depots')">
          <span class="icon">ğŸ¢</span>
          <span class="label">Depots</span>
          <span class="badge" id="depots-count">0</span>
        </div>
      </div>

      <div class="admin-sidebar-footer">
        <button class="btn btn-secondary" style="width: 100%;" onclick="Router.goTo(Router.SCREENS.MAIN)">
          â† Back
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-content">
      <!-- Vehicle Types Section -->
      <div id="vehicle-types-section" class="admin-section active">
        <div class="admin-content-header">
          <h1>Vehicle Types Management</h1>
          <p>Manage your fleet's vehicle types and specifications</p>
        </div>

        <div class="admin-content-body">
          <div class="section-toolbar">
            <div class="toolbar-left">
              <div class="search-box">
                <span class="icon">ğŸ”</span>
                <input type="text" id="search-vehicle-types" placeholder="Search vehicle types..." />
              </div>
            </div>
            <button class="btn btn-primary" onclick="VehicleTypeManager.openAddModal()">
              + Add Vehicle Type
            </button>
          </div>

          <div id="vehicle-types-list" class="items-grid">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>

      <!-- Vehicles Section -->
      <div id="vehicles-section" class="admin-section">
        <div class="admin-content-header">
          <h1>Vehicles Management</h1>
          <p>Manage your fleet vehicles</p>
        </div>

        <div class="admin-content-body">
          <div class="section-toolbar">
            <div class="toolbar-left">
              <div class="search-box">
                <span class="icon">ğŸ”</span>
                <input type="text" id="search-vehicles" placeholder="Search vehicles..." />
              </div>
            </div>
            <button class="btn btn-primary" onclick="VehicleManager.openAddModal()">
              + Add Vehicle
            </button>
          </div>

          <div id="vehicles-list" class="items-grid">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>

      <!-- Depots Section -->
      <div id="depots-section" class="admin-section">
        <div class="admin-content-header">
          <h1>Depots Management</h1>
          <p>Manage warehouse locations</p>
        </div>

        <div class="admin-content-body">
          <div class="empty-state">
            <div class="empty-icon">ğŸ¢</div>
            <div class="empty-text">Depots Management</div>
            <div class="empty-hint">Coming soon...</div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

</body>
</html>