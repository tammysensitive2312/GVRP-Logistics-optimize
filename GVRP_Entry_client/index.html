<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VRP System - Vehicle Route Planning</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="styles/main.css">

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="scripts/auth.js"></script>
  <script src="scripts/api/api.js"></script>
  <script src="scripts/api/query-keys.js"></script>

  <script type="module" src="scripts/components/UI%20Components/sidebar.js"></script>
  <script type="module" src="scripts/components/UI%20Components/navbar.js"></script>
  <script type="module" src="scripts/components/UI%20Components/resizable-divider.js"></script>
  <script type="module" src="scripts/components/UI%20Components/orders-table.js"></script>
  <script type="module" src="scripts/components/UI%20Components/orders-filters.js"></script>

  <script type="module" src="scripts/components/Form%20Components/depot-form.js"></script>
  <script type="module" src="scripts/components/Form%20Components/fleet-form.js"></script>
  <script type="module" src="scripts/components/Form%20Components/vehicle-card.js"></script>
  <script type="module" src="scripts/components/Form%20Components/import-modal.js"></script>
  <script type="module" src="scripts/components/Form%20Components/edit-order-modal.js"></script>

  <script type="module" src="scripts/components/Map%20Components/depot-map.js"></script>
  <script type="module" src="scripts/components/Map%20Components/main-map.js"></script>

  <script type="module" src="scripts/utils/toast.js"></script>
  <script type="module" src="scripts/utils/loading.js"></script>
  <script type="module" src="scripts/utils/validation.js"></script>
  <script type="module" src="scripts/utils/dom-helpers.js"></script>

  <script type="module" src="scripts/core/state.js"></script>
  <script type="module" src="scripts/core/router.js"></script>

  <script type="module" src="scripts/lib/query-cache.js"></script>
  <script type="module" src="scripts/lib/query-helpers.js"></script>

  <script type="module" src="scripts/app.js"></script>
</head>
<body>
<!-- ============================================ -->
<!-- SCREEN 1: DEPOT SETUP -->
<!-- ============================================ -->
<div id="screen-depot-setup" class="screen active">
  <div class="setup-container">
    <div class="setup-header">
      <h1>üè¢ Thi·∫øt l·∫≠p Depot - Kho h√†ng</h1>
      <p>Vui l√≤ng ch·ªçn v·ªã tr√≠ kho h√†ng c·ªßa b·∫°n tr√™n b·∫£n ƒë·ªì</p>
    </div>

    <form id="depot-form" class="setup-form">
      <!-- T√™n Depot -->
      <div class="form-group">
        <label for="depot-name">T√™n Depot <span class="required">*</span></label>
        <input
                type="text"
                id="depot-name"
                name="name"
                placeholder="V√≠ d·ª•: Kho H√† N·ªôi"
                maxlength="100"
                required
        />
      </div>

      <!-- Interactive Map -->
      <div class="form-group">
        <label>V·ªã tr√≠ Depot <span class="required">*</span></label>
        <div id="depot-map" class="setup-map"></div>
        <p class="form-hint">
          üí° Click v√†o b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn v·ªã tr√≠ kho h√†ng c·ªßa b·∫°n
        </p>
      </div>

      <!-- Auto-filled Location Info -->
      <div class="form-group">
        <label for="depot-address">ƒê·ªãa ch·ªâ</label>
        <input
                type="text"
                id="depot-address"
                name="address"
                placeholder="Click v√†o b·∫£n ƒë·ªì ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn ƒë·ªãa ch·ªâ"
                readonly
        />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="depot-lat">Latitude</label>
          <input
                  type="text"
                  id="depot-lat"
                  name="latitude"
                  placeholder="21.028511"
                  readonly
          />
        </div>
        <div class="form-group">
          <label for="depot-lng">Longitude</label>
          <input
                  type="text"
                  id="depot-lng"
                  name="longitude"
                  placeholder="105.804817"
                  readonly
          />
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="DepotForm.reset()">
          H·ªßy
        </button>
        <button type="submit" class="btn btn-primary">
          L∆∞u Depot
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ============================================ -->
<!-- SCREEN 2: FLEET SETUP -->
<!-- ============================================ -->
<div id="screen-fleet-setup" class="screen">
  <div class="setup-container">
    <div class="setup-header">
      <h1>üöö Thi·∫øt l·∫≠p ƒê·ªôi xe</h1>
      <p>Th√™m th√¥ng tin v·ªÅ ƒë·ªôi xe v√† ph∆∞∆°ng ti·ªán c·ªßa b·∫°n</p>
    </div>

    <form id="fleet-form" class="setup-form">
      <!-- T√™n ƒë·ªôi xe -->
      <div class="form-group">
        <label for="fleet-name">T√™n ƒë·ªôi xe <span class="required">*</span></label>
        <input
                type="text"
                id="fleet-name"
                name="fleetName"
                placeholder="V√≠ d·ª•: ƒê·ªôi xe giao h√†ng n·ªôi th√†nh"
                required
        />
      </div>

      <!-- Vehicle List -->
      <div class="form-group">
        <div class="section-header">
          <label>Danh s√°ch Xe <span class="required">*</span></label>
          <button type="button" class="btn btn-sm btn-success" onclick="FleetForm.addVehicle()">
            + Th√™m xe
          </button>
        </div>

        <!-- Available Depots Info -->
        <div id="depots-info" class="depots-info-box" style="display: none;">
          <strong>üìç Depots c√≥ s·∫µn:</strong>
          <div id="depots-list-info"></div>
        </div>

        <div id="vehicles-container" class="vehicles-container">
          <!-- Vehicle items will be added here dynamically -->
        </div>
      </div>

      <!-- Fleet Summary -->
      <div class="fleet-summary">
        <div class="summary-item">
          <span class="summary-label">üìä T·ªïng s·ªë xe:</span>
          <span class="summary-value" id="total-vehicles">0</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">üì¶ T·ªïng t·∫£i tr·ªçng:</span>
          <span class="summary-value" id="total-capacity">0 kg</span>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="Router.goTo(Router.SCREENS.DEPOT_SETUP)">
          ‚Üê Quay l·∫°i
        </button>
        <button type="submit" class="btn btn-primary">
          L∆∞u ƒê·ªôi xe
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ============================================ -->
<!-- SCREEN 3: MAIN SCREEN (Dashboard) -->
<!-- ============================================ -->
<div id="screen-main" class="screen">
  <!-- Top Navbar -->
  <nav class="navbar">
    <div class="navbar-left">
      <button class="btn-icon" onclick="Sidebar.toggle()">‚ò∞</button>
      <div class="brand">
        <span class="brand-icon">üì¶</span>
        <span class="brand-name">VRP System‚Ñ¢</span>
      </div>
    </div>

    <div class="navbar-center">
      <button class="nav-menu-item active">Dashboard</button>
      <button class="nav-menu-item" onclick="alert('Planning screen - VRP-002')">Planning</button>
      <button class="nav-menu-item" onclick="alert('Analysis screen - VRP-006')">Analysis</button>
      <button class="nav-menu-item" onclick="alert('History screen - VRP-005')">History</button>
    </div>

    <div class="navbar-right">
      <div class="user-menu" id="userMenuDropdown">
        <span class="user-avatar">üë§</span>
        <span class="user-name">Admin</span>

        <button class="btn-icon btn-dropdown-trigger" onclick="event.stopPropagation(); Navbar.toggleDropdown('userMenuDropdown')">
          ‚ñº
        </button>

        <div class="dropdown-content">
          <a href="#" onclick="event.preventDefault(); alert('Profile - Coming soon!')">
            üë§ Profile
          </a>
          <a href="#" onclick="event.preventDefault(); alert('Settings - Coming soon!')">
            ‚öôÔ∏è Settings
          </a>
          <div class="divider"></div>
          <a href="#" onclick="event.preventDefault(); Navbar.handleLogout()" style="color: var(--danger-red);">
            üö™ Logout
          </a>
        </div>
      </div>
    </div>
</nav>

  <!-- Main Content -->
  <div class="main-layout">
    <!-- Left Sidebar -->
    <aside id="main-sidebar" class="sidebar">
      <!-- Stats Cards (Horizontal) -->
      <div class="stats-section">
        <h3 class="section-title">üìä TODAY'S STATS</h3>
        <div class="stats-grid">
          <div class="stat-card" onclick="OrdersFilters.filterByStatus('SCHEDULED')">
            <div class="stat-number">0</div>
            <div class="stat-label">Scheduled</div>
          </div>
          <div class="stat-card" onclick="OrdersFilters.filterByStatus('COMPLETED')">
            <div class="stat-number">0</div>
            <div class="stat-label">Completed</div>
          </div>
          <div class="stat-card" onclick="OrdersFilters.filterByStatus('ALL')">
            <div class="stat-number">0</div>
            <div class="stat-label">Total</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">0</div>
            <div class="stat-label">Routes</div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="sidebar-section">
        <div class="section-header" onclick="Sidebar.toggleSection('depots-content', this)">
          <h3 class="section-title">üìç DEPOTS (<span id="depot-count">0</span>)</h3>
          <span class="toggle-icon">‚ñº</span>
        </div>

        <div class="section-content expanded" id="depots-content">
          <div id="depots-list" class="compact-list">
            <div class="empty-message">Loading depots...</div>
          </div>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="section-header" onclick="Sidebar.toggleSection('vehicles-content', this)">
          <h3 class="section-title">üöö VEHICLES (<span id="vehicle-count">0</span>)</h3>
          <span class="toggle-icon">‚ñº</span>
        </div>

        <div class="section-content expanded" id="vehicles-content">
          <div id="vehicles-list" class="compact-list">
            <div class="empty-message">Loading vehicles...</div>
          </div>
        </div>
      </div>

      <!-- Collapse Button -->
      <button class="btn-collapse" onclick="Sidebar.toggle()">
        ‚óÑ Hide Sidebar
      </button>
    </aside>

    <!-- Main Content Area (70%) -->
    <main class="main-content">
      <!-- Map View -->
      <div class="map-container" id="map-section">
        <div id="main-map" class="main-map"></div>
      </div>

      <!-- Resizable Divider -->
      <div class="resize-divider" id="resize-divider">
        <div class="resize-handle">
          <span class="resize-icon">‚ãÆ</span>
        </div>
      </div>

      <!-- Orders Table -->
      <div class="table-container" id="table-section">
        <div class="tab-switcher">
          <button class="tab-btn active" data-tab="orders-tab" onclick="switchContentTab('orders-tab')">Orders</button>
          <button class="tab-btn" data-tab="route-tab" onclick="switchContentTab('route-tab')">Route</button>
          <button class="tab-btn" data-tab="timeline-tab" onclick="switchContentTab('timeline-tab')">Timeline</button>
        </div>
        <div class="tab-content-item active" id="orders-tab">

          <div class="table-header">
            <div class="table-actions-row">
              <button class="btn btn-primary" onclick="openAddOrderModal()">
                <span>+</span> Add Order
              </button>
              <button class="btn btn-secondary" onclick="openImportModal()">
                <span>üì•</span> Import Orders
              </button>
              <button class="btn btn-success" id="btn-plan-routes" disabled>
                <span>üìä</span> Plan Routes
                <span class="badge" id="selected-count">0</span>
              </button>
              <div class="dropdown">
                <button class="btn btn-menu">‚ãÆ</button>
                <div class="dropdown-content">
                  <a href="#" onclick="exportOrders()">Export to CSV</a>
                  <a href="#" onclick="deleteSelectedOrders()">Delete Selected</a>
                  <a href="#" onclick="bulkEditOrders()">Bulk Edit</a>
                </div>
              </div>
            </div>
            <div class="table-filters-row">
              <div class="filter-group">
                <label>üìÖ</label>
                <input type="date" id="filter-date" value="2025-10-21" onchange="loadOrders()" />
              </div>
              <div class="filter-group">
                <label>Status:</label>
                <select id="filter-status" onchange="applyFilters()">
                  <option value="">All</option>
                  <option value="SCHEDULED">Scheduled</option>
                  <option value="ON_ROUTE">On Route</option>
                  <option value="COMPLETED">Completed</option>
                  <option value="FAILED">Failed</option>
                </select>
              </div>
              <div class="filter-group search">
                <span>üîç</span>
                <input type="text" id="filter-search" placeholder="Search orders..." oninput="applyFilters()" />
              </div>
              <button class="btn btn-text" onclick="clearFilters()">Clear</button>
              <button class="btn btn-secondary" onclick="refreshAllData()" title="Refresh data from server">
                üîÑ
              </button>
            </div>
          </div>


          <div class="table-content">
            <table id="orders-table" class="data-table">
              <thead>
              <tr>
                <th><input type="checkbox" id="select-all" onchange="toggleSelectAll()" /></th>
                <th>Order Code</th>
                <th>Customer</th>
                <th>Address</th>
                <th>Priority</th>
                <th>Time window</th>
                <th>Capacity</th>
                <th>Time service</th>
                <th>Notes</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
              </thead>
              <tbody id="orders-tbody">
              </tbody>
            </table>
          </div>

          <div class="table-footer">
            <div class="footer-info">
              <span>‚úÖ Selected: <strong id="footer-selected">0</strong> orders</span>
              <span class="separator">|</span>
              <span>Showing <strong id="footer-showing">0</strong> of <strong id="footer-total">0</strong> orders</span>
            </div>
            <div class="pagination">
              <button class="btn-page" onclick="previousPage()" disabled>¬´ Previous</button>
              <button class="btn-page active">1</button>
              <button class="btn-page" onclick="nextPage()" disabled>Next ¬ª</button>
            </div>
          </div>
        </div>

        <div class="tab-content-item" id="route-tab">
          <div class="route-planning-view">
            <h3>üó∫Ô∏è Route Planning & Optimization</h3>
            <p>N·ªôi dung hi·ªÉn th·ªã c√°c tuy·∫øn ƒë∆∞·ªùng ƒë√£ ƒë∆∞·ª£c quy ho·∫°ch, b·∫£n ƒë·ªì t∆∞∆°ng t√°c, v√† danh s√°ch Stops/Jobs.</p>
          </div>
        </div>

        <div class="tab-content-item" id="timeline-tab">
          <div class="timeline-view">
            <h3>üïí Route Timeline (Gantt Chart)</h3>
            <p>N·ªôi dung hi·ªÉn th·ªã bi·ªÉu ƒë·ªì Gantt, tr·ª±c quan h√≥a l·ªãch tr√¨nh xe ch·∫°y v√† th·ªùi gian ph·ª•c v·ª•.</p>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- ============================================ -->
<!-- SCREEN 4: IMPORT ORDERS MODAL -->
<!-- ============================================ -->
<div id="modal-import" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üì• Import Orders</h2>
      <button class="btn-close" onclick="closeImportModal()">‚úï</button>
    </div>

    <form id="import-form" class="modal-body">
      <!-- Import Method Selection (Horizontal) -->
      <div class="form-group">
        <div class="import-method-grid">
          <div class="import-method-label">
            <label>Import method:</label>
          </div>
          <div class="import-method-options">
            <label class="radio-label-inline">
              <input type="radio" name="import-method" value="file" checked onchange="toggleImportMethod()" />
              <span>üìÅ File (CSV/Excel)</span>
            </label>
            <label class="radio-label-inline">
              <input type="radio" name="import-method" value="text" onchange="toggleImportMethod()" />
              <span>üìù Raw Text</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Overwrite Checkbox (Right below import method) -->
      <div class="form-group">
        <div class="import-method-grid">
          <div class="import-method-label">
            <label>Overwrite existing:</label>
          </div>
          <div class="import-method-options">
            <label class="checkbox-label-inline">
              <input type="checkbox" id="import-overwrite" />
            </label>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- File Upload Section -->
      <div id="import-file-section" class="import-section">
        <div class="form-group">
          <label>Upload File</label>
          <div class="file-upload-zone" id="file-drop-zone">
            <input type="file" id="import-file" accept=".csv,.xlsx" onchange="handleFileSelect(event)" hidden />
            <div class="upload-content">
              <div class="upload-icon">üìÅ</div>
              <div class="upload-text">
                <p><strong>Click to select file</strong> or drag and drop</p>
                <p class="upload-hint">CSV or Excel files (max 10MB)</p>
              </div>
            </div>
            <div class="file-selected" id="file-selected" style="display: none;">
              <span class="file-name" id="file-name"></span>
              <button type="button" class="btn-remove" onclick="removeFile()">‚úï</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Text Input Section -->
      <div id="import-text-section" class="import-section" style="display: none;">
        <div class="form-group">
          <label>Order data</label>
          <div class="format-hint">
            <strong>Format:</strong> OrderCode|Name|Phone|Address|Lat|Lng|Demand|TWStart|TWEnd|Priority|Notes
          </div>
          <textarea
                  id="import-text"
                  rows="10"
                  placeholder="ORD001|John|0901234567|123 Main St|21.028511|105.804817|50.5|08:00|12:00|1|Handle with care&#10;ORD002|Jane|0912345678|456 Second Ave|21.030000|105.810000|30.0||||2|"
          ></textarea>
        </div>
      </div>

      <!-- Common Fields -->
      <div class="form-row">
        <div class="form-group">
          <label for="import-delivery-date">Delivery date <span class="required">*</span></label>
          <input type="date" id="import-delivery-date" required />
        </div>
        <div class="form-group">
          <label for="import-service-time">Service time (minutes) <span class="required">*</span></label>
          <input type="number" id="import-service-time" value="5" min="0" required />
        </div>
      </div>

      <!-- Helper Section -->
      <div class="help-section">
        <h4>üí° Hint:</h4>
        <ul>
          <li>CSV File: max 10MB</li>
          <li>Support UTF-8 encoding</li>
          <li>Template: <a href="#" onclick="downloadTemplate()">Download sample file</a></li>
        </ul>
      </div>
    </form>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeImportModal()">
        Cancel
      </button>
      <button type="button" class="btn btn-primary" onclick="submitImport()">
        Import
      </button>
    </div>
  </div>
</div>

<!-- ============================================ -->
<!-- EDIT ORDER MODAL -->
<!-- ============================================ -->
<div id="modal-edit-order" class="modal">
  <div class="modal-content modal-large">
    <div class="modal-header">
      <h2 class="modal-title">üìù Edit Order</h2>
      <button class="btn-close" onclick="EditOrderModal.close()">‚úï</button>
    </div>

    <form id="edit-order-form" class="modal-body">
      <!-- Basic Information -->
      <div class="form-section">
        <h3 class="form-section-title">üìã Basic Information</h3>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-order-code">Order Code <span class="required">*</span></label>
            <input type="text" id="edit-order-code" placeholder="ORD001" required />
          </div>

          <div class="form-group">
            <label for="edit-status">Status</label>
            <select id="edit-status">
              <option value="SCHEDULED">Scheduled</option>
              <option value="ON_ROUTE">On Route</option>
              <option value="COMPLETED">Completed</option>
              <option value="FAILED">Failed</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-customer-name">Customer Name <span class="required">*</span></label>
            <input type="text" id="edit-customer-name" placeholder="John Doe" required />
          </div>

          <div class="form-group">
            <label for="edit-customer-phone">Phone Number</label>
            <input type="tel" id="edit-customer-phone" placeholder="0901234567" />
          </div>
        </div>
      </div>

      <!-- Location -->
      <div class="form-section">
        <h3 class="form-section-title">üìç Location</h3>

        <div class="form-group">
          <label for="edit-address">Address <span class="required">*</span></label>
          <input type="text" id="edit-address" placeholder="123 Main Street" required />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-latitude">Latitude <span class="required">*</span></label>
            <input type="number" id="edit-latitude" step="any" placeholder="21.028511" required />
          </div>

          <div class="form-group">
            <label for="edit-longitude">Longitude <span class="required">*</span></label>
            <input type="number" id="edit-longitude" step="any" placeholder="105.804817" required />
          </div>
        </div>

        <button type="button" class="btn btn-secondary btn-sm" onclick="EditOrderModal.openLocationPicker()">
          üó∫Ô∏è Pick Location on Map
        </button>
      </div>

      <!-- Order Details -->
      <div class="form-section">
        <h3 class="form-section-title">üì¶ Order Details</h3>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-demand">Demand (kg) <span class="required">*</span></label>
            <input type="number" id="edit-demand" step="0.1" min="0.1" placeholder="50.5" required />
          </div>

          <div class="form-group">
            <label for="edit-service-time">Service Time (minutes) <span class="required">*</span></label>
            <input type="number" id="edit-service-time" min="0" value="5" required />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-priority">Priority (1-10)</label>
            <input type="number" id="edit-priority" min="1" max="10" value="5" />
          </div>

          <div class="form-group">
            <label for="edit-delivery-date">Delivery Date</label>
            <input type="date" id="edit-delivery-date" />
          </div>
        </div>
      </div>

      <!-- Time Windows -->
      <div class="form-section">
        <h3 class="form-section-title">‚è∞ Time Windows (Optional)</h3>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-time-window-start">Start Time</label>
            <input type="time" id="edit-time-window-start" placeholder="08:00" />
          </div>

          <div class="form-group">
            <label for="edit-time-window-end">End Time</label>
            <input type="time" id="edit-time-window-end" placeholder="12:00" />
          </div>
        </div>
      </div>

      <!-- Delivery Notes -->
      <div class="form-section">
        <h3 class="form-section-title">üìù Notes</h3>

        <div class="form-group">
          <label for="edit-delivery-notes">Delivery Notes</label>
          <textarea id="edit-delivery-notes" rows="3" placeholder="Special instructions..."></textarea>
        </div>
      </div>
    </form>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="EditOrderModal.close()">
        Cancel
      </button>
      <button type="submit" form="edit-order-form" class="btn btn-primary">
        üíæ Save
      </button>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay" style="display: none;">
  <div class="loading-spinner"></div>
  <div class="loading-text">ƒêang x·ª≠ l√Ω...</div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast"></div>

</body>
</html>